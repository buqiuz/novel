<!--<!DOCTYPE html>-->
<!--<html lang="zh">-->
<!--<head>-->
<!--    <meta charset="UTF-8">-->
<!--    <meta name="viewport" content="width=device-width, initial-scale=1.0">-->
<!--    <title>小说封面生成器</title>-->
<!--    <style>-->
<!--        * {-->
<!--            box-sizing: border-box;-->
<!--            margin: 0;-->
<!--            padding: 0;-->
<!--        }-->

<!--        body {-->
<!--            font-family: 'Microsoft YaHei', sans-serif;-->
<!--            background-color: #f5f5f5;-->
<!--            padding: 20px;-->
<!--        }-->

<!--        .container {-->
<!--            max-width: 1000px;-->
<!--            margin: 0 auto;-->
<!--            background: #fff;-->
<!--            border-radius: 10px;-->
<!--            padding: 30px;-->
<!--            box-shadow: 0 0 20px rgba(0,0,0,0.1);-->
<!--        }-->

<!--        .header {-->
<!--            text-align: center;-->
<!--            margin-bottom: 30px;-->
<!--        }-->

<!--        .header h1 {-->
<!--            color: #333;-->
<!--            margin-bottom: 10px;-->
<!--        }-->

<!--        .header p {-->
<!--            color: #666;-->
<!--        }-->

<!--        .form-group {-->
<!--            margin-bottom: 20px;-->
<!--        }-->

<!--        label {-->
<!--            display: block;-->
<!--            margin-bottom: 8px;-->
<!--            font-weight: bold;-->
<!--            color: #444;-->
<!--        }-->

<!--        input[type="number"] {-->
<!--            width: 100%;-->
<!--            padding: 10px 15px;-->
<!--            border: 1px solid #ddd;-->
<!--            border-radius: 5px;-->
<!--            font-size: 16px;-->
<!--        }-->

<!--        button {-->
<!--            background: #4CAF50;-->
<!--            color: white;-->
<!--            border: none;-->
<!--            padding: 12px 24px;-->
<!--            font-size: 16px;-->
<!--            border-radius: 5px;-->
<!--            cursor: pointer;-->
<!--            transition: background 0.3s;-->
<!--            display: block;-->
<!--            width: 100%;-->
<!--        }-->

<!--        button:hover {-->
<!--            background: #45a049;-->
<!--        }-->

<!--        button:disabled {-->
<!--            background: #cccccc;-->
<!--            cursor: not-allowed;-->
<!--        }-->

<!--        .result-section {-->
<!--            margin-top: 30px;-->
<!--            display: none;-->
<!--        }-->

<!--        .book-info {-->
<!--            background: #f9f9f9;-->
<!--            border-radius: 8px;-->
<!--            padding: 15px;-->
<!--            margin-bottom: 20px;-->
<!--        }-->

<!--        .book-info p {-->
<!--            margin-bottom: 10px;-->
<!--        }-->

<!--        .covers-container {-->
<!--            display: grid;-->
<!--            grid-template-columns: 1fr 1fr;-->
<!--            gap: 20px;-->
<!--            margin-bottom: 30px;-->
<!--        }-->

<!--        .cover-box {-->
<!--            border: 1px solid #ddd;-->
<!--            border-radius: 8px;-->
<!--            padding: 15px;-->
<!--            text-align: center;-->
<!--        }-->

<!--        .cover-box h3 {-->
<!--            margin-bottom: 15px;-->
<!--            color: #333;-->
<!--        }-->

<!--        .cover-image {-->
<!--            width: 100%;-->
<!--            height: auto;-->
<!--            max-height: 400px;-->
<!--            object-fit: contain;-->
<!--            margin-bottom: 15px;-->
<!--            border-radius: 5px;-->
<!--        }-->

<!--        .action-buttons {-->
<!--            display: flex;-->
<!--            gap: 10px;-->
<!--        }-->

<!--        .action-buttons button {-->
<!--            flex: 1;-->
<!--        }-->

<!--        .action-buttons .regenerate {-->
<!--            background: #2196F3;-->
<!--        }-->

<!--        .action-buttons .regenerate:hover {-->
<!--            background: #0b7dda;-->
<!--        }-->

<!--        .action-buttons .apply {-->
<!--            background: #ff9800;-->
<!--        }-->

<!--        .action-buttons .apply:hover {-->
<!--            background: #e68a00;-->
<!--        }-->

<!--        .loading-overlay {-->
<!--            position: fixed;-->
<!--            top: 0;-->
<!--            left: 0;-->
<!--            width: 100%;-->
<!--            height: 100%;-->
<!--            background: rgba(0,0,0,0.7);-->
<!--            display: flex;-->
<!--            flex-direction: column;-->
<!--            justify-content: center;-->
<!--            align-items: center;-->
<!--            z-index: 1000;-->
<!--        }-->

<!--        .loading-spinner {-->
<!--            border: 5px solid #f3f3f3;-->
<!--            border-top: 5px solid #3498db;-->
<!--            border-radius: 50%;-->
<!--            width: 50px;-->
<!--            height: 50px;-->
<!--            animation: spin 2s linear infinite;-->
<!--            margin-bottom: 20px;-->
<!--        }-->

<!--        .loading-text {-->
<!--            color: white;-->
<!--            font-size: 20px;-->
<!--        }-->

<!--        .message-box {-->
<!--            padding: 15px;-->
<!--            border-radius: 5px;-->
<!--            margin-bottom: 20px;-->
<!--            text-align: center;-->
<!--        }-->

<!--        .message-box.success {-->
<!--            background-color: #dff0d8;-->
<!--            color: #3c763d;-->
<!--        }-->

<!--        .message-box.error {-->
<!--            background-color: #f2dede;-->
<!--            color: #a94442;-->
<!--        }-->

<!--        @keyframes spin {-->
<!--            0% { transform: rotate(0deg); }-->
<!--            100% { transform: rotate(360deg); }-->
<!--        }-->
<!--    </style>-->
<!--</head>-->
<!--<body>-->
<!--<div class="container">-->
<!--    <div class="header">-->
<!--        <h1>小说封面AI生成器</h1>-->
<!--        <p>输入小说ID，系统将自动生成并更新封面</p>-->
<!--    </div>-->

<!--    <div class="form-group">-->
<!--        <label for="bookId">请输入小说ID：</label>-->
<!--        <input type="number" id="bookId" placeholder="例如：123456" min="1">-->
<!--    </div>-->

<!--    <button id="generateBtn">生成封面</button>-->

<!--    <div id="messageContainer"></div>-->

<!--    <div class="result-section" id="resultSection">-->
<!--        <h2>小说信息</h2>-->
<!--        <div class="book-info" id="bookInfo"></div>-->

<!--        <h2>封面预览</h2>-->
<!--        <div class="covers-container">-->
<!--            <div class="cover-box">-->
<!--                <h3>当前封面</h3>-->
<!--                <img id="originalCover" class="cover-image" alt="当前封面">-->
<!--            </div>-->
<!--            <div class="cover-box">-->
<!--                <h3>AI生成封面</h3>-->
<!--                <img id="newCover" class="cover-image" alt="AI生成封面">-->
<!--                <div class="action-buttons">-->
<!--                    <button class="regenerate" id="regenerateBtn">重新生成</button>-->
<!--                    <button class="apply" id="applyBtn">应用封面</button>-->
<!--                </div>-->
<!--            </div>-->
<!--        </div>-->
<!--    </div>-->
<!--</div>-->

<!--<script>-->
<!--    // 获取DOM元素-->
<!--    const bookIdInput = document.getElementById('bookId');-->
<!--    const generateBtn = document.getElementById('generateBtn');-->
<!--    const resultSection = document.getElementById('resultSection');-->
<!--    const bookInfoDiv = document.getElementById('bookInfo');-->
<!--    const originalCoverImg = document.getElementById('originalCover');-->
<!--    const newCoverImg = document.getElementById('newCover');-->
<!--    const regenerateBtn = document.getElementById('regenerateBtn');-->
<!--    const applyBtn = document.getElementById('applyBtn');-->
<!--    const messageContainer = document.getElementById('messageContainer');-->

<!--    // 存储当前书籍信息-->
<!--    let currentBookInfo = null;-->
<!--    let generatedImageUrl = null;-->

<!--    // 按钮事件监听-->
<!--    generateBtn.addEventListener('click', handleGenerateClick);-->
<!--    regenerateBtn.addEventListener('click', handleRegenerateClick);-->
<!--    applyBtn.addEventListener('click', handleApplyClick);-->

<!--    // 生成封面按钮点击处理-->
<!--    async function handleGenerateClick() {-->
<!--        const bookId = bookIdInput.value.trim();-->
<!--        if (!bookId) {-->
<!--            showMessage('请输入有效的小说ID', 'error');-->
<!--            return;-->
<!--        }-->

<!--        await generateBookCover(bookId);-->
<!--    }-->

<!--    // 重新生成按钮点击处理-->
<!--    async function handleRegenerateClick() {-->
<!--        if (!currentBookInfo) return;-->

<!--        showLoading('正在重新生成封面...');-->
<!--        try {-->
<!--            // 使用现有小说信息重新生成封面-->
<!--            const prompt = generatePromptFromBookInfo(currentBookInfo);-->
<!--            const imageUrl = await generateImage(prompt);-->
<!--            if (!imageUrl) {-->
<!--                throw new Error('图片生成失败');-->
<!--            }-->

<!--            // 转换图片格式-->
<!--            const jpgUrl = await convertPngToJpg(imageUrl);-->
<!--            if (!jpgUrl) {-->
<!--                throw new Error('图片格式转换失败');-->
<!--            }-->

<!--            // 更新界面显示-->
<!--            generatedImageUrl = jpgUrl;-->
<!--            newCoverImg.src = jpgUrl;-->

<!--            showMessage('封面重新生成成功！', 'success');-->
<!--        } catch (error) {-->
<!--            console.error('重新生成封面错误:', error);-->
<!--            showMessage('封面重新生成失败: ' + error.message, 'error');-->
<!--        } finally {-->
<!--            hideLoading();-->
<!--        }-->
<!--    }-->

<!--    // 应用封面按钮点击处理-->
<!--    async function handleApplyClick() {-->
<!--        if (!currentBookInfo || !generatedImageUrl) return;-->

<!--        showLoading('正在更新小说封面...');-->
<!--        try {-->
<!--            // 更新小说封面-->
<!--            const result = await updateBookCover(currentBookInfo.id, generatedImageUrl);-->
<!--            if (!result) {-->
<!--                throw new Error('更新封面失败');-->
<!--            }-->

<!--            // 更新原始封面显示-->
<!--            originalCoverImg.src = generatedImageUrl;-->
<!--            // 更新当前书籍信息中的封面URL-->
<!--            currentBookInfo.picUrl = generatedImageUrl;-->

<!--            showMessage('小说封面更新成功！', 'success');-->
<!--        } catch (error) {-->
<!--            console.error('应用封面错误:', error);-->
<!--            showMessage('应用封面失败: ' + error.message, 'error');-->
<!--        } finally {-->
<!--            hideLoading();-->
<!--        }-->
<!--    }-->

<!--    // 小说封面生成主函数-->
<!--    async function generateBookCover(bookId) {-->
<!--        try {-->
<!--            // 显示加载提示-->
<!--            showLoading('正在处理中，请稍候...');-->

<!--            // 1. 获取小说信息-->
<!--            const bookInfo = await fetchBookInfo(bookId);-->
<!--            if (!bookInfo) {-->
<!--                throw new Error('获取小说信息失败2');-->
<!--            }-->

<!--            // 保存当前书籍信息-->
<!--            currentBookInfo = bookInfo;-->

<!--            // 2. 显示小说信息-->
<!--            displayBookInfo(bookInfo);-->

<!--            // 3. 构建AI绘图提示词-->
<!--            const prompt = generatePromptFromBookInfo(bookInfo);-->

<!--            // 4. 调用AI接口生成图片-->
<!--            const imageUrl = await generateImage(prompt);-->
<!--            if (!imageUrl) {-->
<!--                throw new Error('图片生成失败');-->
<!--            }-->

<!--            // 5. 将PNG格式转换为JPG格式-->
<!--            const jpgUrl = await convertPngToJpg(imageUrl);-->
<!--            if (!jpgUrl) {-->
<!--                throw new Error('图片格式转换失败');-->
<!--            }-->

<!--            // 保存生成的图片URL-->
<!--            generatedImageUrl = jpgUrl;-->

<!--            // 6. 显示结果-->
<!--            displayResults(bookInfo.picUrl, jpgUrl);-->

<!--            showMessage('封面生成成功！', 'success');-->
<!--        } catch (error) {-->
<!--            console.error('生成封面过程中发生错误:', error);-->
<!--            showMessage('操作失败: ' + error.message, 'error');-->
<!--            hideResults();-->
<!--        } finally {-->
<!--            hideLoading();-->
<!--        }-->
<!--    }-->

<!--    // 获取小说信息-->
<!--    async function fetchBookInfo(bookId) {-->
<!--        try {-->
<!--            const response = await fetch(`/api/front/book/${bookId}`, {-->
<!--                method: 'GET',-->
<!--            });-->
<!--            const result = await response.json(); // 👈 必须解析 JSON-->

<!--            if (result.code === '00000' && result.data) {-->
<!--                return result.data;-->
<!--            } else {-->
<!--                throw new Error(result.message || '获取小说信息失败1');-->
<!--            }-->
<!--        } catch (error) {-->
<!--            console.error('获取小说信息错误:', error);-->
<!--            return null;-->
<!--        }-->
<!--    }-->


<!--    // 根据小说信息生成提示词-->
<!--    function generatePromptFromBookInfo(bookInfo) {-->
<!--        // 基础提示词模板-->
<!--        let prompt = `为小说《${bookInfo.bookName}》创作一个精美的封面，`;-->

<!--        // 根据小说类别添加风格描述-->
<!--        if (bookInfo.categoryName.includes('玄幻')) {-->
<!--            prompt += '风格为东方玄幻，包含神秘元素，魔法光效，';-->
<!--        } else if (bookInfo.categoryName.includes('科幻')) {-->
<!--            prompt += '风格为未来科技感，包含太空或科技元素，';-->
<!--        } else if (bookInfo.categoryName.includes('仙侠')) {-->
<!--            prompt += '风格为古风仙侠，飘逸灵动，包含山水元素，';-->
<!--        } else if (bookInfo.categoryName.includes('都市')) {-->
<!--            prompt += '风格为现代都市，时尚简约，';-->
<!--        } else if (bookInfo.categoryName.includes('历史')) {-->
<!--            prompt += '风格为古典历史，厚重沉稳，';-->
<!--        }-->

<!--        // 根据作品方向调整-->
<!--        if (bookInfo.workDirection === 0) { // 男频-->
<!--            prompt += '设计偏向于阳刚之气，色调较为深沉，';-->
<!--        } else { // 女频-->
<!--            prompt += '设计偏向于柔美风格，色调较为明亮，';-->
<!--        }-->

<!--        // 添加小说描述中的关键元素-->
<!--        const keywords = extractKeywords(bookInfo.bookDesc);-->
<!--        if (keywords && keywords.length > 0) {-->
<!--            prompt += `包含以下元素：${keywords.join('、')}，`;-->
<!--        }-->

<!--        // 完善提示词-->
<!--        prompt += '整体画面精致唯美，具有强烈的视觉冲击力，适合作为小说封面。高清细节，8K分辨率。';-->

<!--        return prompt;-->
<!--    }-->

<!--    // 从小说描述中提取关键词-->
<!--    function extractKeywords(description) {-->
<!--        if (!description) return [];-->

<!--        // 这里可以实现一个简单的关键词提取算法-->
<!--        // 以下是一个简化版本，实际应用中可以使用更复杂的NLP算法-->
<!--        const words = description.split(/[,，.。!！?？\s]+/);-->
<!--        const filteredWords = words.filter(word => word.length >= 2 && word.length <= 4);-->

<!--        // 返回最多5个关键词-->
<!--        return filteredWords.slice(0, 5);-->
<!--    }-->

<!--    // 调用AI接口生成图片-->
<!--    async function generateImage(prompt) {-->
<!--        try {-->
<!--            const response = await fetch('/api/front/ai/textToImage', {-->
<!--                method: 'POST',-->
<!--                headers: {-->
<!--                    'Content-Type': 'application/json'-->
<!--                },-->
<!--                body: JSON.stringify({ text: prompt })-->
<!--            });-->

<!--            if (!response.ok) {-->
<!--                throw new Error('生成图片请求失败');-->
<!--            }-->

<!--            const result = await response.json();-->
<!--            if (result.code === '00000' && result.data) {-->
<!--                return result.data; // 返回生成的图片URL-->
<!--            } else {-->
<!--                throw new Error(result.message || '生成图片失败');-->
<!--            }-->
<!--        } catch (error) {-->
<!--            console.error('生成图片错误:', error);-->
<!--            return null;-->
<!--        }-->
<!--    }-->

<!--    // 将PNG转换为JPG-->
<!--    async function convertPngToJpg(pngUrl) {-->
<!--        try {-->
<!--            const response = await fetch('/api/front/ai/pngToJpg', {-->
<!--                method: 'POST',-->
<!--                headers: {-->
<!--                    'Content-Type': 'application/json'-->
<!--                },-->
<!--                body: JSON.stringify({ url: pngUrl })-->
<!--            });-->

<!--            if (!response.ok) {-->
<!--                throw new Error('图片格式转换请求失败');-->
<!--            }-->

<!--            const result = await response.json();-->
<!--            if (result.code === '00000' && result.data) {-->
<!--                return result.data; // 返回转换后的JPG图片URL-->
<!--            } else {-->
<!--                throw new Error(result.message || '图片格式转换失败');-->
<!--            }-->
<!--        } catch (error) {-->
<!--            console.error('图片格式转换错误:', error);-->
<!--            return null;-->
<!--        }-->
<!--    }-->

<!--    // 更新小说封面-->
<!--    // 更新小说封面-->
<!--    async function updateBookCover(bookId, imageUrl) {-->
<!--        try {-->
<!--            // 构建更新请求数据（与请求参数结构严格一致）-->
<!--            const updateData = {-->
<!--                id: bookId,-->
<!--                workDirection: currentBookInfo.workDirection ?? 0,     // ✅ 确保非 null-->
<!--                categoryId: currentBookInfo.categoryId ?? 0,-->
<!--                categoryName: currentBookInfo.categoryName || '未知',   // ✅ 给默认值，防止为空-->
<!--                picUrl: imageUrl,-->
<!--                bookName: currentBookInfo.bookName || '未命名小说',-->
<!--                bookDesc: currentBookInfo.bookDesc || '',-->
<!--                bookStatus: currentBookInfo.bookStatus ?? 0,-->
<!--                isVip: currentBookInfo.isVip ?? 0,-->
<!--                authorId: currentBookInfo.authorId ?? 0-->
<!--            };-->


<!--            // 发送更新请求-->
<!--            const response = await fetch('http://127.0.0.1:20003/api/inner/book/updateBook', {-->
<!--                method: 'POST',-->
<!--                headers: {-->
<!--                    'Content-Type': 'application/json'-->
<!--                },-->
<!--                body: JSON.stringify(updateData)-->
<!--            });-->

<!--            if (!response.ok) {-->
<!--                throw new Error('更新小说封面请求失败');-->
<!--            }-->

<!--            const result = await response.json();-->
<!--            return result.code === '00000';-->
<!--        } catch (error) {-->
<!--            console.error('更新小说封面错误:', error);-->
<!--            return false;-->
<!--        }-->
<!--    }-->





<!--    // 显示小说信息-->
<!--    function displayBookInfo(bookInfo) {-->
<!--        let html = `-->
<!--                <p><strong>书名：</strong>${bookInfo.bookName}</p>-->
<!--                <p><strong>类别：</strong>${bookInfo.categoryName}</p>-->
<!--                <p><strong>方向：</strong>${bookInfo.workDirection === 0 ? '女频' : '男频'}</p>-->
<!--                <p><strong>状态：</strong>${bookInfo.bookStatus === 0 ? '连载中' : '已完结'}</p>-->
<!--                <p><strong>简介：</strong>${bookInfo.bookDesc}</p>-->
<!--            `;-->

<!--        bookInfoDiv.innerHTML = html;-->
<!--    }-->

<!--    // 显示结果-->
<!--    function displayResults(originalUrl, newUrl) {-->
<!--        originalCoverImg.src = originalUrl;-->
<!--        newCoverImg.src = newUrl;-->
<!--        resultSection.style.display = 'block';-->
<!--    }-->

<!--    // 隐藏结果-->
<!--    function hideResults() {-->
<!--        resultSection.style.display = 'none';-->
<!--    }-->

<!--    // UI辅助函数-->
<!--    function showLoading(message) {-->
<!--        const loadingEl = document.createElement('div');-->
<!--        loadingEl.id = 'cover-loading';-->
<!--        loadingEl.className = 'loading-overlay';-->
<!--        loadingEl.innerHTML = `-->
<!--                <div class="loading-spinner"></div>-->
<!--                <div class="loading-text">${message}</div>-->
<!--            `;-->
<!--        document.body.appendChild(loadingEl);-->
<!--    }-->

<!--    function hideLoading() {-->
<!--        const loadingEl = document.getElementById('cover-loading');-->
<!--        if (loadingEl) {-->
<!--            loadingEl.remove();-->
<!--        }-->
<!--    }-->

<!--    function showMessage(message, type) {-->
<!--        const messageEl = document.createElement('div');-->
<!--        messageEl.className = `message-box ${type}`;-->
<!--        messageEl.textContent = message;-->

<!--        // 清除之前的消息-->
<!--        messageContainer.innerHTML = '';-->
<!--        messageContainer.appendChild(messageEl);-->

<!--        // 5秒后自动清除消息-->
<!--        setTimeout(() => {-->
<!--            messageEl.remove();-->
<!--        }, 5000);-->
<!--    }-->
<!--</script>-->
<!--</body>-->
<!--</html>-->

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>小说封面批量更新工具</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            color: #333;
        }
        .book-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .book-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            position: relative;
        }
        .book-card.selected {
            border-color: #1890ff;
            background-color: #e6f7ff;
        }
        .book-cover {
            width: 100%;
            height: 220px;
            object-fit: cover;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        .book-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .book-author {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
        }
        .checkbox {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        .controls {
            margin: 20px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .pagination {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        button {
            padding: 8px 16px;
            background-color: #1890ff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #40a9ff;
        }
        button:disabled {
            background-color: #d9d9d9;
            cursor: not-allowed;
        }
        .prompt-input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            font-size: 24px;
            font-weight: bold;
        }
        .status-message {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }
        .status-message.success {
            background-color: #f6ffed;
            border: 1px solid #b7eb8f;
            color: #52c41a;
        }
        .status-message.error {
            background-color: #fff2f0;
            border: 1px solid #ffccc7;
            color: #ff4d4f;
        }
        .status-message.info {
            background-color: #e6f7ff;
            border: 1px solid #91d5ff;
            color: #1890ff;
        }
        .book-description {
            font-size: 12px;
            color: #888;
            max-height: 60px;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
        }
        .page-size-selector {
            margin-left: 10px;
        }
        .prompt-container {
            margin: 15px 0;
            border: 1px solid #e8e8e8;
            border-radius: 8px;
            padding: 15px;
            background-color: #fafafa;
        }

        .prompt-label {
            display: block;
            font-weight: bold;
            margin-bottom: 8px;
            color: #333;
        }

        .prompt-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            font-size: 14px;
            resize: vertical;
            min-height: 80px;
            font-family: inherit;
        }

        .prompt-tips {
            margin-top: 8px;
            font-size: 12px;
            color: #888;
            line-height: 1.5;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>小说封面批量更新工具</h1>

    <div class="controls">
        <div>
            <button id="selectAll">全选</button>
            <button id="deselectAll">取消全选</button>
            <button id="generateCovers">生成选中图片</button>
            <select id="pageSizeSelector" class="page-size-selector">
                <option value="10">10条/页</option>
                <option value="20" selected>20条/页</option>
                <option value="50">50条/页</option>
                <option value="100">100条/页</option>
            </select>
        </div>
        <div class="pagination">
            <button id="prevPage" disabled>上一页</button>
            <span id="pageInfo">第 1 页</span>
            <button id="nextPage">下一页</button>
        </div>
    </div>

    <div class="prompt-container">
        <label for="promptTemplate" class="prompt-label">AI绘图提示词模板:</label>
        <textarea id="promptTemplate" class="prompt-input" rows="3"
                  placeholder="输入AI图片生成提示词模板，支持以下变量：
- {bookName}: 书名
- {authorName}: 作者名
- {bookDesc}: 书籍描述
- {categoryName}: 小说分类
- {workDirection}: 男频/女频">为小说《{bookName}》创建一个精美的封面图片，风格为{categoryName}类型，{workDirection}小说。
作者是{authorName}，内容简介：{bookDesc}
整体效果要高清细腻，具有视觉冲击力，适合作为专业小说封面。</textarea>
        <div class="prompt-tips">提示：合理的提示词可以生成更好的封面。建议包含书名、类型和简短描述。描述仅使用前200字。</div>
    </div>

    <div id="statusMessages"></div>

    <div class="book-list" id="bookList">
        <!-- 书籍列表将通过JavaScript动态生成 -->
    </div>
</div>

<div class="loading" id="loading" style="display: none;">
    <div>处理中，请稍候...</div>
</div>

<script>
    // 全局变量
    let currentBooks = []; // 当前页面显示的书籍
    let currentPage = 1;   // 当前页码
    let pageSize = 20;     // 每页数量
    let totalBooks = 0;    // 总书籍数
    let totalPages = 1;    // 总页数
    let selectedBooks = new Map(); // 使用Map存储选中的书籍，键为书籍ID

    // DOM元素
    const bookListEl = document.getElementById('bookList');
    const prevPageBtn = document.getElementById('prevPage');
    const nextPageBtn = document.getElementById('nextPage');
    const pageInfoEl = document.getElementById('pageInfo');
    const selectAllBtn = document.getElementById('selectAll');
    const deselectAllBtn = document.getElementById('deselectAll');
    const generateCoversBtn = document.getElementById('generateCovers');
    const promptTemplateEl = document.getElementById('promptTemplate');
    const loadingEl = document.getElementById('loading');
    const statusMessagesEl = document.getElementById('statusMessages');
    const pageSizeSelector = document.getElementById('pageSizeSelector');

    // 初始化
    window.onload = function() {
        fetchBooks(currentPage, pageSize);

        // 绑定事件
        prevPageBtn.addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                fetchBooks(currentPage, pageSize);
            }
        });

        nextPageBtn.addEventListener('click', () => {
            if (currentPage < totalPages) {
                currentPage++;
                fetchBooks(currentPage, pageSize);
            }
        });

        selectAllBtn.addEventListener('click', selectAllBooks);
        deselectAllBtn.addEventListener('click', deselectAllBooks);
        generateCoversBtn.addEventListener('click', generateSelectedCovers);

        pageSizeSelector.addEventListener('change', () => {
            pageSize = parseInt(pageSizeSelector.value);
            currentPage = 1; // 切换每页数量后重置为第一页
            fetchBooks(currentPage, pageSize);
        });
    };

    // // 修改翻页逻辑，确保最后一页不会与之前页重复
    // async function fetchBooks(pageNum, pageSize) {
    //     showLoading();
    //     try {
    //         // 确保页码不超过总页数
    //         if (totalPages > 0 && pageNum > totalPages) {
    //             pageNum = totalPages;
    //         }
    //
    //         const response = await fetch(`http://127.0.0.1:8888/api/front/book/listAll?pageNum=${pageNum}&pageSize=${pageSize}`);
    //
    //         if (!response.ok) {
    //             throw new Error(`HTTP错误: ${response.status}`);
    //         }
    //
    //         const data = await response.json();
    //
    //         if (data.code !== "00000") {
    //             throw new Error(`API错误: ${data.message || '未知错误'}`);
    //         }
    //
    //         // 更新全局变量
    //         currentBooks = data.data.list || [];
    //         totalBooks = data.data.total || 0;
    //         totalPages = Math.ceil(totalBooks / pageSize);
    //
    //         // 计算总页数时使用向上取整
    //         totalPages = Math.max(1, Math.ceil(totalBooks / pageSize));
    //
    //         // 如果当前页超过了总页数，重新请求最后一页
    //         if (pageNum > totalPages && totalPages > 0) {
    //             return fetchBooks(totalPages, pageSize);
    //         }
    //
    //         // 渲染书籍列表
    //         renderBooks();
    //
    //         // 更新分页控件
    //         updatePaginationControls();
    //     } catch (error) {
    //         showStatusMessage(`获取书籍列表失败: ${error.message}`, 'error');
    //     } finally {
    //         hideLoading();
    //     }
    // }
    async function fetchBooks(pageNum, pageSize) {
        showLoading();
        try {
            // 确保页码有效
            pageNum = Math.max(1, Math.min(pageNum, totalPages || 1));

            const response = await fetch(`http://127.0.0.1:8888/api/front/book/listAll?pageNum=${pageNum}&pageSize=${pageSize}`);

            if (!response.ok) {
                throw new Error(`HTTP错误: ${response.status}`);
            }

            const data = await response.json();

            if (data.code !== "00000") {
                throw new Error(`API错误: ${data.message || '未知错误'}`);
            }

            // 更新全局变量
            currentBooks = data.data.list || [];
            totalBooks = data.data.total || 0;
            totalPages = Math.max(1, Math.ceil(totalBooks / pageSize));
            currentPage = pageNum; // 确保当前页与请求页一致

            // 渲染书籍列表
            renderBooks();

            // 更新分页控件
            updatePaginationControls();
        } catch (error) {
            showStatusMessage(`获取书籍列表失败: ${error.message}`, 'error');
        } finally {
            hideLoading();
        }
    }

    // 更新分页控件函数
    function updatePaginationControls() {
        pageInfoEl.textContent = `第 ${currentPage} 页，共 ${totalPages} 页，总计 ${totalBooks} 条`;
        prevPageBtn.disabled = currentPage <= 1;
        nextPageBtn.disabled = currentPage >= totalPages || totalPages === 0;
    }

    // 下一页按钮事件处理
    nextPageBtn.addEventListener('click', () => {
        if (currentPage < totalPages) {
            currentPage++;
            fetchBooks(currentPage, pageSize);
        }
    });

    // 渲染书籍列表
    function renderBooks() {
        bookListEl.innerHTML = '';

        if (currentBooks.length === 0) {
            bookListEl.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 20px;">暂无数据</div>';
            return;
        }

        currentBooks.forEach(book => {
            const isSelected = selectedBooks.has(book.id);

            const bookCard = document.createElement('div');
            bookCard.className = `book-card ${isSelected ? 'selected' : ''}`;
            bookCard.dataset.id = book.id;

            // 准备图片URL，如果有缓存的新图片就使用新图片
            const bookFromMap = selectedBooks.get(book.id);
            const coverImg = bookFromMap && bookFromMap.newImageUrl
                ? bookFromMap.newImageUrl
                : book.picUrl;

            bookCard.innerHTML = `
                <input type="checkbox" class="checkbox" ${isSelected ? 'checked' : ''}>
                <img src="${coverImg || ''}" alt="${book.bookName}" class="book-cover"
                     onerror="this.src='http://localhost:20000/default.gif'">
                <div class="book-title">${book.bookName || '未知标题'}</div>
                <div class="book-author">作者: ${book.authorName || '未知'}</div>
                <div class="book-description">${book.bookDesc || '暂无描述'}</div>
                ${bookFromMap && bookFromMap.newImageUrl ? '<div style="color: green; margin-top: 5px;">✓ 图片已更新</div>' : ''}
            `;

            const checkbox = bookCard.querySelector('.checkbox');
            checkbox.addEventListener('change', () => {
                if (checkbox.checked) {
                    // 添加到选中列表
                    selectedBooks.set(book.id, {...book});
                    bookCard.classList.add('selected');
                } else {
                    // 从选中列表移除
                    selectedBooks.delete(book.id);
                    bookCard.classList.remove('selected');
                }
            });

            bookListEl.appendChild(bookCard);
        });
    }

    // 全选当前页面的书籍
    function selectAllBooks() {
        currentBooks.forEach(book => {
            selectedBooks.set(book.id, {...book});
        });
        renderBooks();
    }

    // 取消选中当前页面的书籍
    function deselectAllBooks() {
        currentBooks.forEach(book => {
            selectedBooks.delete(book.id);
        });
        renderBooks();
    }

    function decodeHtmlEntities(str) {
        const txt = document.createElement('textarea');
        txt.innerHTML = str;
        return txt.value;
    }


    // 生成选中的封面
    async function generateSelectedCovers() {
        if (selectedBooks.size === 0) {
            showStatusMessage('请至少选择一本书籍', 'error');
            return;
        }

        showLoading();

        // 获取选中的书籍列表
        const booksToUpdate = Array.from(selectedBooks.values());
        let successCount = 0;
        let failCount = 0;

        for (const book of booksToUpdate) {
            try {
                // 1. 生成提示词
                const promptTemplate = promptTemplateEl.value;
                const workDirectionText = book.workDirection === 0 ? '男频' : '女频';
                const prompt = promptTemplate
                    .replace('{bookName}', book.bookName || '')
                    .replace('{authorName}', book.authorName || '未知作者')
                    .replace('{bookDesc}', (book.bookDesc || '').substring(0, 200)) // 限制描述长度
                    .replace('{categoryName}', book.categoryName || '未分类')
                    .replace('{workDirection}', workDirectionText);

                // 2. 调用文生图API
                showStatusMessage(`正在为《${book.bookName}》生成封面...`, 'info');
                const imageResponse = await fetch('http://127.0.0.1:8888/api/front/ai/textToImage', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ text: prompt })
                });

                if (!imageResponse.ok) {
                    throw new Error(`图片生成请求失败: ${imageResponse.status}`);
                }

                const imageData = await imageResponse.json();

                if (imageData.code !== "00000" || !imageData.data) {
                    throw new Error(`图片生成失败: ${imageData.message || '未知错误'}`);
                }

                const pngUrl = imageData.data;

                // 3. 调用PNG转JPG API
                showStatusMessage(`正在转换《${book.bookName}》的封面格式...`, 'info');
                const convertResponse = await fetch('http://127.0.0.1:8888/api/front/ai/pngToJpg', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ url: pngUrl })
                });

                if (!convertResponse.ok) {
                    throw new Error(`图片转换请求失败: ${convertResponse.status}`);
                }

                const convertData = await convertResponse.json();

                if (convertData.code !== "00000" || !convertData.data) {
                    throw new Error(`图片转换失败: ${convertData.message || '未知错误'}`);
                }

                const jpgUrl = convertData.data;

                // 4. 更新书籍封面
                showStatusMessage(`正在更新《${book.bookName}》的封面信息...`, 'info');

                // 确保所有必要字段都有值，防止空值导致后端错误
                const updateData = {
                    id: book.id,
                    workDirection: book.workDirection ?? 0,
                    categoryId: book.categoryId ?? 0,
                    categoryName: book.categoryName || '未分类',
                    picUrl: jpgUrl,
                    bookName: book.bookName || '未命名',
                    bookDesc: decodeHtmlEntities(book.bookDesc || ''),
                    bookStatus: book.bookStatus ?? 0,
                    isVip: book.isVip ?? 0,
                    authorId: book.authorId ?? 0,
                    authorName: book.authorName || '未知作者'
                };

                const updateResponse = await fetch('http://127.0.0.1:20003/api/inner/book/updateBook', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updateData)
                });

                if (!updateResponse.ok) {
                    throw new Error(`书籍信息更新请求失败: ${updateResponse.status}`);
                }

                const updateResult = await updateResponse.json();

                if (updateResult.code !== "00000") {
                    throw new Error(`书籍信息更新失败: ${updateResult.message || '未知错误'}`);
                }

                // 更新选中书籍中的信息
                const updatedBook = selectedBooks.get(book.id);
                if (updatedBook) {
                    updatedBook.picUrl = jpgUrl;
                    updatedBook.newImageUrl = jpgUrl;
                    selectedBooks.set(book.id, updatedBook);
                }

                showStatusMessage(`《${book.bookName}》封面更新成功！`, 'success');
                successCount++;
            } catch (error) {
                showStatusMessage(`《${book.bookName}》处理失败: ${error.message}`, 'error');
                failCount++;
            }
        }

        // 更新总结果
        showStatusMessage(`处理完成: ${successCount}本成功，${failCount}本失败`,
            successCount > 0 ? 'success' : 'error');

        // 重新加载当前页面数据，显示最新状态
        fetchBooks(currentPage, pageSize);

        hideLoading();
    }

    // 显示加载中
    function showLoading() {
        loadingEl.style.display = 'flex';
    }

    // 隐藏加载中
    function hideLoading() {
        loadingEl.style.display = 'none';
    }

    // 显示状态消息
    function showStatusMessage(message, type = 'info') {
        const messageEl = document.createElement('div');
        messageEl.className = `status-message ${type}`;
        messageEl.textContent = message;

        statusMessagesEl.appendChild(messageEl);

        // 5秒后自动移除
        setTimeout(() => {
            if (statusMessagesEl.contains(messageEl)) {
                statusMessagesEl.removeChild(messageEl);
            }
        }, 5000);
    }
</script>
</body>
</html>