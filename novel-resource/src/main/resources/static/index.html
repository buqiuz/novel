<!--<!DOCTYPE html>-->
<!--<html lang="zh">-->
<!--<head>-->
<!--    <meta charset="UTF-8">-->
<!--    <meta name="viewport" content="width=device-width, initial-scale=1.0">-->
<!--    <title>å°è¯´å°é¢ç”Ÿæˆå™¨</title>-->
<!--    <style>-->
<!--        * {-->
<!--            box-sizing: border-box;-->
<!--            margin: 0;-->
<!--            padding: 0;-->
<!--        }-->

<!--        body {-->
<!--            font-family: 'Microsoft YaHei', sans-serif;-->
<!--            background-color: #f5f5f5;-->
<!--            padding: 20px;-->
<!--        }-->

<!--        .container {-->
<!--            max-width: 1000px;-->
<!--            margin: 0 auto;-->
<!--            background: #fff;-->
<!--            border-radius: 10px;-->
<!--            padding: 30px;-->
<!--            box-shadow: 0 0 20px rgba(0,0,0,0.1);-->
<!--        }-->

<!--        .header {-->
<!--            text-align: center;-->
<!--            margin-bottom: 30px;-->
<!--        }-->

<!--        .header h1 {-->
<!--            color: #333;-->
<!--            margin-bottom: 10px;-->
<!--        }-->

<!--        .header p {-->
<!--            color: #666;-->
<!--        }-->

<!--        .form-group {-->
<!--            margin-bottom: 20px;-->
<!--        }-->

<!--        label {-->
<!--            display: block;-->
<!--            margin-bottom: 8px;-->
<!--            font-weight: bold;-->
<!--            color: #444;-->
<!--        }-->

<!--        input[type="number"] {-->
<!--            width: 100%;-->
<!--            padding: 10px 15px;-->
<!--            border: 1px solid #ddd;-->
<!--            border-radius: 5px;-->
<!--            font-size: 16px;-->
<!--        }-->

<!--        button {-->
<!--            background: #4CAF50;-->
<!--            color: white;-->
<!--            border: none;-->
<!--            padding: 12px 24px;-->
<!--            font-size: 16px;-->
<!--            border-radius: 5px;-->
<!--            cursor: pointer;-->
<!--            transition: background 0.3s;-->
<!--            display: block;-->
<!--            width: 100%;-->
<!--        }-->

<!--        button:hover {-->
<!--            background: #45a049;-->
<!--        }-->

<!--        button:disabled {-->
<!--            background: #cccccc;-->
<!--            cursor: not-allowed;-->
<!--        }-->

<!--        .result-section {-->
<!--            margin-top: 30px;-->
<!--            display: none;-->
<!--        }-->

<!--        .book-info {-->
<!--            background: #f9f9f9;-->
<!--            border-radius: 8px;-->
<!--            padding: 15px;-->
<!--            margin-bottom: 20px;-->
<!--        }-->

<!--        .book-info p {-->
<!--            margin-bottom: 10px;-->
<!--        }-->

<!--        .covers-container {-->
<!--            display: grid;-->
<!--            grid-template-columns: 1fr 1fr;-->
<!--            gap: 20px;-->
<!--            margin-bottom: 30px;-->
<!--        }-->

<!--        .cover-box {-->
<!--            border: 1px solid #ddd;-->
<!--            border-radius: 8px;-->
<!--            padding: 15px;-->
<!--            text-align: center;-->
<!--        }-->

<!--        .cover-box h3 {-->
<!--            margin-bottom: 15px;-->
<!--            color: #333;-->
<!--        }-->

<!--        .cover-image {-->
<!--            width: 100%;-->
<!--            height: auto;-->
<!--            max-height: 400px;-->
<!--            object-fit: contain;-->
<!--            margin-bottom: 15px;-->
<!--            border-radius: 5px;-->
<!--        }-->

<!--        .action-buttons {-->
<!--            display: flex;-->
<!--            gap: 10px;-->
<!--        }-->

<!--        .action-buttons button {-->
<!--            flex: 1;-->
<!--        }-->

<!--        .action-buttons .regenerate {-->
<!--            background: #2196F3;-->
<!--        }-->

<!--        .action-buttons .regenerate:hover {-->
<!--            background: #0b7dda;-->
<!--        }-->

<!--        .action-buttons .apply {-->
<!--            background: #ff9800;-->
<!--        }-->

<!--        .action-buttons .apply:hover {-->
<!--            background: #e68a00;-->
<!--        }-->

<!--        .loading-overlay {-->
<!--            position: fixed;-->
<!--            top: 0;-->
<!--            left: 0;-->
<!--            width: 100%;-->
<!--            height: 100%;-->
<!--            background: rgba(0,0,0,0.7);-->
<!--            display: flex;-->
<!--            flex-direction: column;-->
<!--            justify-content: center;-->
<!--            align-items: center;-->
<!--            z-index: 1000;-->
<!--        }-->

<!--        .loading-spinner {-->
<!--            border: 5px solid #f3f3f3;-->
<!--            border-top: 5px solid #3498db;-->
<!--            border-radius: 50%;-->
<!--            width: 50px;-->
<!--            height: 50px;-->
<!--            animation: spin 2s linear infinite;-->
<!--            margin-bottom: 20px;-->
<!--        }-->

<!--        .loading-text {-->
<!--            color: white;-->
<!--            font-size: 20px;-->
<!--        }-->

<!--        .message-box {-->
<!--            padding: 15px;-->
<!--            border-radius: 5px;-->
<!--            margin-bottom: 20px;-->
<!--            text-align: center;-->
<!--        }-->

<!--        .message-box.success {-->
<!--            background-color: #dff0d8;-->
<!--            color: #3c763d;-->
<!--        }-->

<!--        .message-box.error {-->
<!--            background-color: #f2dede;-->
<!--            color: #a94442;-->
<!--        }-->

<!--        @keyframes spin {-->
<!--            0% { transform: rotate(0deg); }-->
<!--            100% { transform: rotate(360deg); }-->
<!--        }-->
<!--    </style>-->
<!--</head>-->
<!--<body>-->
<!--<div class="container">-->
<!--    <div class="header">-->
<!--        <h1>å°è¯´å°é¢AIç”Ÿæˆå™¨</h1>-->
<!--        <p>è¾“å…¥å°è¯´IDï¼Œç³»ç»Ÿå°†è‡ªåŠ¨ç”Ÿæˆå¹¶æ›´æ–°å°é¢</p>-->
<!--    </div>-->

<!--    <div class="form-group">-->
<!--        <label for="bookId">è¯·è¾“å…¥å°è¯´IDï¼š</label>-->
<!--        <input type="number" id="bookId" placeholder="ä¾‹å¦‚ï¼š123456" min="1">-->
<!--    </div>-->

<!--    <button id="generateBtn">ç”Ÿæˆå°é¢</button>-->

<!--    <div id="messageContainer"></div>-->

<!--    <div class="result-section" id="resultSection">-->
<!--        <h2>å°è¯´ä¿¡æ¯</h2>-->
<!--        <div class="book-info" id="bookInfo"></div>-->

<!--        <h2>å°é¢é¢„è§ˆ</h2>-->
<!--        <div class="covers-container">-->
<!--            <div class="cover-box">-->
<!--                <h3>å½“å‰å°é¢</h3>-->
<!--                <img id="originalCover" class="cover-image" alt="å½“å‰å°é¢">-->
<!--            </div>-->
<!--            <div class="cover-box">-->
<!--                <h3>AIç”Ÿæˆå°é¢</h3>-->
<!--                <img id="newCover" class="cover-image" alt="AIç”Ÿæˆå°é¢">-->
<!--                <div class="action-buttons">-->
<!--                    <button class="regenerate" id="regenerateBtn">é‡æ–°ç”Ÿæˆ</button>-->
<!--                    <button class="apply" id="applyBtn">åº”ç”¨å°é¢</button>-->
<!--                </div>-->
<!--            </div>-->
<!--        </div>-->
<!--    </div>-->
<!--</div>-->

<!--<script>-->
<!--    // è·å–DOMå…ƒç´ -->
<!--    const bookIdInput = document.getElementById('bookId');-->
<!--    const generateBtn = document.getElementById('generateBtn');-->
<!--    const resultSection = document.getElementById('resultSection');-->
<!--    const bookInfoDiv = document.getElementById('bookInfo');-->
<!--    const originalCoverImg = document.getElementById('originalCover');-->
<!--    const newCoverImg = document.getElementById('newCover');-->
<!--    const regenerateBtn = document.getElementById('regenerateBtn');-->
<!--    const applyBtn = document.getElementById('applyBtn');-->
<!--    const messageContainer = document.getElementById('messageContainer');-->

<!--    // å­˜å‚¨å½“å‰ä¹¦ç±ä¿¡æ¯-->
<!--    let currentBookInfo = null;-->
<!--    let generatedImageUrl = null;-->

<!--    // æŒ‰é’®äº‹ä»¶ç›‘å¬-->
<!--    generateBtn.addEventListener('click', handleGenerateClick);-->
<!--    regenerateBtn.addEventListener('click', handleRegenerateClick);-->
<!--    applyBtn.addEventListener('click', handleApplyClick);-->

<!--    // ç”Ÿæˆå°é¢æŒ‰é’®ç‚¹å‡»å¤„ç†-->
<!--    async function handleGenerateClick() {-->
<!--        const bookId = bookIdInput.value.trim();-->
<!--        if (!bookId) {-->
<!--            showMessage('è¯·è¾“å…¥æœ‰æ•ˆçš„å°è¯´ID', 'error');-->
<!--            return;-->
<!--        }-->

<!--        await generateBookCover(bookId);-->
<!--    }-->

<!--    // é‡æ–°ç”ŸæˆæŒ‰é’®ç‚¹å‡»å¤„ç†-->
<!--    async function handleRegenerateClick() {-->
<!--        if (!currentBookInfo) return;-->

<!--        showLoading('æ­£åœ¨é‡æ–°ç”Ÿæˆå°é¢...');-->
<!--        try {-->
<!--            // ä½¿ç”¨ç°æœ‰å°è¯´ä¿¡æ¯é‡æ–°ç”Ÿæˆå°é¢-->
<!--            const prompt = generatePromptFromBookInfo(currentBookInfo);-->
<!--            const imageUrl = await generateImage(prompt);-->
<!--            if (!imageUrl) {-->
<!--                throw new Error('å›¾ç‰‡ç”Ÿæˆå¤±è´¥');-->
<!--            }-->

<!--            // è½¬æ¢å›¾ç‰‡æ ¼å¼-->
<!--            const jpgUrl = await convertPngToJpg(imageUrl);-->
<!--            if (!jpgUrl) {-->
<!--                throw new Error('å›¾ç‰‡æ ¼å¼è½¬æ¢å¤±è´¥');-->
<!--            }-->

<!--            // æ›´æ–°ç•Œé¢æ˜¾ç¤º-->
<!--            generatedImageUrl = jpgUrl;-->
<!--            newCoverImg.src = jpgUrl;-->

<!--            showMessage('å°é¢é‡æ–°ç”ŸæˆæˆåŠŸï¼', 'success');-->
<!--        } catch (error) {-->
<!--            console.error('é‡æ–°ç”Ÿæˆå°é¢é”™è¯¯:', error);-->
<!--            showMessage('å°é¢é‡æ–°ç”Ÿæˆå¤±è´¥: ' + error.message, 'error');-->
<!--        } finally {-->
<!--            hideLoading();-->
<!--        }-->
<!--    }-->

<!--    // åº”ç”¨å°é¢æŒ‰é’®ç‚¹å‡»å¤„ç†-->
<!--    async function handleApplyClick() {-->
<!--        if (!currentBookInfo || !generatedImageUrl) return;-->

<!--        showLoading('æ­£åœ¨æ›´æ–°å°è¯´å°é¢...');-->
<!--        try {-->
<!--            // æ›´æ–°å°è¯´å°é¢-->
<!--            const result = await updateBookCover(currentBookInfo.id, generatedImageUrl);-->
<!--            if (!result) {-->
<!--                throw new Error('æ›´æ–°å°é¢å¤±è´¥');-->
<!--            }-->

<!--            // æ›´æ–°åŸå§‹å°é¢æ˜¾ç¤º-->
<!--            originalCoverImg.src = generatedImageUrl;-->
<!--            // æ›´æ–°å½“å‰ä¹¦ç±ä¿¡æ¯ä¸­çš„å°é¢URL-->
<!--            currentBookInfo.picUrl = generatedImageUrl;-->

<!--            showMessage('å°è¯´å°é¢æ›´æ–°æˆåŠŸï¼', 'success');-->
<!--        } catch (error) {-->
<!--            console.error('åº”ç”¨å°é¢é”™è¯¯:', error);-->
<!--            showMessage('åº”ç”¨å°é¢å¤±è´¥: ' + error.message, 'error');-->
<!--        } finally {-->
<!--            hideLoading();-->
<!--        }-->
<!--    }-->

<!--    // å°è¯´å°é¢ç”Ÿæˆä¸»å‡½æ•°-->
<!--    async function generateBookCover(bookId) {-->
<!--        try {-->
<!--            // æ˜¾ç¤ºåŠ è½½æç¤º-->
<!--            showLoading('æ­£åœ¨å¤„ç†ä¸­ï¼Œè¯·ç¨å€™...');-->

<!--            // 1. è·å–å°è¯´ä¿¡æ¯-->
<!--            const bookInfo = await fetchBookInfo(bookId);-->
<!--            if (!bookInfo) {-->
<!--                throw new Error('è·å–å°è¯´ä¿¡æ¯å¤±è´¥2');-->
<!--            }-->

<!--            // ä¿å­˜å½“å‰ä¹¦ç±ä¿¡æ¯-->
<!--            currentBookInfo = bookInfo;-->

<!--            // 2. æ˜¾ç¤ºå°è¯´ä¿¡æ¯-->
<!--            displayBookInfo(bookInfo);-->

<!--            // 3. æ„å»ºAIç»˜å›¾æç¤ºè¯-->
<!--            const prompt = generatePromptFromBookInfo(bookInfo);-->

<!--            // 4. è°ƒç”¨AIæ¥å£ç”Ÿæˆå›¾ç‰‡-->
<!--            const imageUrl = await generateImage(prompt);-->
<!--            if (!imageUrl) {-->
<!--                throw new Error('å›¾ç‰‡ç”Ÿæˆå¤±è´¥');-->
<!--            }-->

<!--            // 5. å°†PNGæ ¼å¼è½¬æ¢ä¸ºJPGæ ¼å¼-->
<!--            const jpgUrl = await convertPngToJpg(imageUrl);-->
<!--            if (!jpgUrl) {-->
<!--                throw new Error('å›¾ç‰‡æ ¼å¼è½¬æ¢å¤±è´¥');-->
<!--            }-->

<!--            // ä¿å­˜ç”Ÿæˆçš„å›¾ç‰‡URL-->
<!--            generatedImageUrl = jpgUrl;-->

<!--            // 6. æ˜¾ç¤ºç»“æœ-->
<!--            displayResults(bookInfo.picUrl, jpgUrl);-->

<!--            showMessage('å°é¢ç”ŸæˆæˆåŠŸï¼', 'success');-->
<!--        } catch (error) {-->
<!--            console.error('ç”Ÿæˆå°é¢è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯:', error);-->
<!--            showMessage('æ“ä½œå¤±è´¥: ' + error.message, 'error');-->
<!--            hideResults();-->
<!--        } finally {-->
<!--            hideLoading();-->
<!--        }-->
<!--    }-->

<!--    // è·å–å°è¯´ä¿¡æ¯-->
<!--    async function fetchBookInfo(bookId) {-->
<!--        try {-->
<!--            const response = await fetch(`/api/front/book/${bookId}`, {-->
<!--                method: 'GET',-->
<!--            });-->
<!--            const result = await response.json(); // ğŸ‘ˆ å¿…é¡»è§£æ JSON-->

<!--            if (result.code === '00000' && result.data) {-->
<!--                return result.data;-->
<!--            } else {-->
<!--                throw new Error(result.message || 'è·å–å°è¯´ä¿¡æ¯å¤±è´¥1');-->
<!--            }-->
<!--        } catch (error) {-->
<!--            console.error('è·å–å°è¯´ä¿¡æ¯é”™è¯¯:', error);-->
<!--            return null;-->
<!--        }-->
<!--    }-->


<!--    // æ ¹æ®å°è¯´ä¿¡æ¯ç”Ÿæˆæç¤ºè¯-->
<!--    function generatePromptFromBookInfo(bookInfo) {-->
<!--        // åŸºç¡€æç¤ºè¯æ¨¡æ¿-->
<!--        let prompt = `ä¸ºå°è¯´ã€Š${bookInfo.bookName}ã€‹åˆ›ä½œä¸€ä¸ªç²¾ç¾çš„å°é¢ï¼Œ`;-->

<!--        // æ ¹æ®å°è¯´ç±»åˆ«æ·»åŠ é£æ ¼æè¿°-->
<!--        if (bookInfo.categoryName.includes('ç„å¹»')) {-->
<!--            prompt += 'é£æ ¼ä¸ºä¸œæ–¹ç„å¹»ï¼ŒåŒ…å«ç¥ç§˜å…ƒç´ ï¼Œé­”æ³•å…‰æ•ˆï¼Œ';-->
<!--        } else if (bookInfo.categoryName.includes('ç§‘å¹»')) {-->
<!--            prompt += 'é£æ ¼ä¸ºæœªæ¥ç§‘æŠ€æ„Ÿï¼ŒåŒ…å«å¤ªç©ºæˆ–ç§‘æŠ€å…ƒç´ ï¼Œ';-->
<!--        } else if (bookInfo.categoryName.includes('ä»™ä¾ ')) {-->
<!--            prompt += 'é£æ ¼ä¸ºå¤é£ä»™ä¾ ï¼Œé£˜é€¸çµåŠ¨ï¼ŒåŒ…å«å±±æ°´å…ƒç´ ï¼Œ';-->
<!--        } else if (bookInfo.categoryName.includes('éƒ½å¸‚')) {-->
<!--            prompt += 'é£æ ¼ä¸ºç°ä»£éƒ½å¸‚ï¼Œæ—¶å°šç®€çº¦ï¼Œ';-->
<!--        } else if (bookInfo.categoryName.includes('å†å²')) {-->
<!--            prompt += 'é£æ ¼ä¸ºå¤å…¸å†å²ï¼Œåšé‡æ²‰ç¨³ï¼Œ';-->
<!--        }-->

<!--        // æ ¹æ®ä½œå“æ–¹å‘è°ƒæ•´-->
<!--        if (bookInfo.workDirection === 0) { // ç”·é¢‘-->
<!--            prompt += 'è®¾è®¡åå‘äºé˜³åˆšä¹‹æ°”ï¼Œè‰²è°ƒè¾ƒä¸ºæ·±æ²‰ï¼Œ';-->
<!--        } else { // å¥³é¢‘-->
<!--            prompt += 'è®¾è®¡åå‘äºæŸ”ç¾é£æ ¼ï¼Œè‰²è°ƒè¾ƒä¸ºæ˜äº®ï¼Œ';-->
<!--        }-->

<!--        // æ·»åŠ å°è¯´æè¿°ä¸­çš„å…³é”®å…ƒç´ -->
<!--        const keywords = extractKeywords(bookInfo.bookDesc);-->
<!--        if (keywords && keywords.length > 0) {-->
<!--            prompt += `åŒ…å«ä»¥ä¸‹å…ƒç´ ï¼š${keywords.join('ã€')}ï¼Œ`;-->
<!--        }-->

<!--        // å®Œå–„æç¤ºè¯-->
<!--        prompt += 'æ•´ä½“ç”»é¢ç²¾è‡´å”¯ç¾ï¼Œå…·æœ‰å¼ºçƒˆçš„è§†è§‰å†²å‡»åŠ›ï¼Œé€‚åˆä½œä¸ºå°è¯´å°é¢ã€‚é«˜æ¸…ç»†èŠ‚ï¼Œ8Kåˆ†è¾¨ç‡ã€‚';-->

<!--        return prompt;-->
<!--    }-->

<!--    // ä»å°è¯´æè¿°ä¸­æå–å…³é”®è¯-->
<!--    function extractKeywords(description) {-->
<!--        if (!description) return [];-->

<!--        // è¿™é‡Œå¯ä»¥å®ç°ä¸€ä¸ªç®€å•çš„å…³é”®è¯æå–ç®—æ³•-->
<!--        // ä»¥ä¸‹æ˜¯ä¸€ä¸ªç®€åŒ–ç‰ˆæœ¬ï¼Œå®é™…åº”ç”¨ä¸­å¯ä»¥ä½¿ç”¨æ›´å¤æ‚çš„NLPç®—æ³•-->
<!--        const words = description.split(/[,ï¼Œ.ã€‚!ï¼?ï¼Ÿ\s]+/);-->
<!--        const filteredWords = words.filter(word => word.length >= 2 && word.length <= 4);-->

<!--        // è¿”å›æœ€å¤š5ä¸ªå…³é”®è¯-->
<!--        return filteredWords.slice(0, 5);-->
<!--    }-->

<!--    // è°ƒç”¨AIæ¥å£ç”Ÿæˆå›¾ç‰‡-->
<!--    async function generateImage(prompt) {-->
<!--        try {-->
<!--            const response = await fetch('/api/front/ai/textToImage', {-->
<!--                method: 'POST',-->
<!--                headers: {-->
<!--                    'Content-Type': 'application/json'-->
<!--                },-->
<!--                body: JSON.stringify({ text: prompt })-->
<!--            });-->

<!--            if (!response.ok) {-->
<!--                throw new Error('ç”Ÿæˆå›¾ç‰‡è¯·æ±‚å¤±è´¥');-->
<!--            }-->

<!--            const result = await response.json();-->
<!--            if (result.code === '00000' && result.data) {-->
<!--                return result.data; // è¿”å›ç”Ÿæˆçš„å›¾ç‰‡URL-->
<!--            } else {-->
<!--                throw new Error(result.message || 'ç”Ÿæˆå›¾ç‰‡å¤±è´¥');-->
<!--            }-->
<!--        } catch (error) {-->
<!--            console.error('ç”Ÿæˆå›¾ç‰‡é”™è¯¯:', error);-->
<!--            return null;-->
<!--        }-->
<!--    }-->

<!--    // å°†PNGè½¬æ¢ä¸ºJPG-->
<!--    async function convertPngToJpg(pngUrl) {-->
<!--        try {-->
<!--            const response = await fetch('/api/front/ai/pngToJpg', {-->
<!--                method: 'POST',-->
<!--                headers: {-->
<!--                    'Content-Type': 'application/json'-->
<!--                },-->
<!--                body: JSON.stringify({ url: pngUrl })-->
<!--            });-->

<!--            if (!response.ok) {-->
<!--                throw new Error('å›¾ç‰‡æ ¼å¼è½¬æ¢è¯·æ±‚å¤±è´¥');-->
<!--            }-->

<!--            const result = await response.json();-->
<!--            if (result.code === '00000' && result.data) {-->
<!--                return result.data; // è¿”å›è½¬æ¢åçš„JPGå›¾ç‰‡URL-->
<!--            } else {-->
<!--                throw new Error(result.message || 'å›¾ç‰‡æ ¼å¼è½¬æ¢å¤±è´¥');-->
<!--            }-->
<!--        } catch (error) {-->
<!--            console.error('å›¾ç‰‡æ ¼å¼è½¬æ¢é”™è¯¯:', error);-->
<!--            return null;-->
<!--        }-->
<!--    }-->

<!--    // æ›´æ–°å°è¯´å°é¢-->
<!--    // æ›´æ–°å°è¯´å°é¢-->
<!--    async function updateBookCover(bookId, imageUrl) {-->
<!--        try {-->
<!--            // æ„å»ºæ›´æ–°è¯·æ±‚æ•°æ®ï¼ˆä¸è¯·æ±‚å‚æ•°ç»“æ„ä¸¥æ ¼ä¸€è‡´ï¼‰-->
<!--            const updateData = {-->
<!--                id: bookId,-->
<!--                workDirection: currentBookInfo.workDirection ?? 0,     // âœ… ç¡®ä¿é null-->
<!--                categoryId: currentBookInfo.categoryId ?? 0,-->
<!--                categoryName: currentBookInfo.categoryName || 'æœªçŸ¥',   // âœ… ç»™é»˜è®¤å€¼ï¼Œé˜²æ­¢ä¸ºç©º-->
<!--                picUrl: imageUrl,-->
<!--                bookName: currentBookInfo.bookName || 'æœªå‘½åå°è¯´',-->
<!--                bookDesc: currentBookInfo.bookDesc || '',-->
<!--                bookStatus: currentBookInfo.bookStatus ?? 0,-->
<!--                isVip: currentBookInfo.isVip ?? 0,-->
<!--                authorId: currentBookInfo.authorId ?? 0-->
<!--            };-->


<!--            // å‘é€æ›´æ–°è¯·æ±‚-->
<!--            const response = await fetch('http://127.0.0.1:20003/api/inner/book/updateBook', {-->
<!--                method: 'POST',-->
<!--                headers: {-->
<!--                    'Content-Type': 'application/json'-->
<!--                },-->
<!--                body: JSON.stringify(updateData)-->
<!--            });-->

<!--            if (!response.ok) {-->
<!--                throw new Error('æ›´æ–°å°è¯´å°é¢è¯·æ±‚å¤±è´¥');-->
<!--            }-->

<!--            const result = await response.json();-->
<!--            return result.code === '00000';-->
<!--        } catch (error) {-->
<!--            console.error('æ›´æ–°å°è¯´å°é¢é”™è¯¯:', error);-->
<!--            return false;-->
<!--        }-->
<!--    }-->





<!--    // æ˜¾ç¤ºå°è¯´ä¿¡æ¯-->
<!--    function displayBookInfo(bookInfo) {-->
<!--        let html = `-->
<!--                <p><strong>ä¹¦åï¼š</strong>${bookInfo.bookName}</p>-->
<!--                <p><strong>ç±»åˆ«ï¼š</strong>${bookInfo.categoryName}</p>-->
<!--                <p><strong>æ–¹å‘ï¼š</strong>${bookInfo.workDirection === 0 ? 'å¥³é¢‘' : 'ç”·é¢‘'}</p>-->
<!--                <p><strong>çŠ¶æ€ï¼š</strong>${bookInfo.bookStatus === 0 ? 'è¿è½½ä¸­' : 'å·²å®Œç»“'}</p>-->
<!--                <p><strong>ç®€ä»‹ï¼š</strong>${bookInfo.bookDesc}</p>-->
<!--            `;-->

<!--        bookInfoDiv.innerHTML = html;-->
<!--    }-->

<!--    // æ˜¾ç¤ºç»“æœ-->
<!--    function displayResults(originalUrl, newUrl) {-->
<!--        originalCoverImg.src = originalUrl;-->
<!--        newCoverImg.src = newUrl;-->
<!--        resultSection.style.display = 'block';-->
<!--    }-->

<!--    // éšè—ç»“æœ-->
<!--    function hideResults() {-->
<!--        resultSection.style.display = 'none';-->
<!--    }-->

<!--    // UIè¾…åŠ©å‡½æ•°-->
<!--    function showLoading(message) {-->
<!--        const loadingEl = document.createElement('div');-->
<!--        loadingEl.id = 'cover-loading';-->
<!--        loadingEl.className = 'loading-overlay';-->
<!--        loadingEl.innerHTML = `-->
<!--                <div class="loading-spinner"></div>-->
<!--                <div class="loading-text">${message}</div>-->
<!--            `;-->
<!--        document.body.appendChild(loadingEl);-->
<!--    }-->

<!--    function hideLoading() {-->
<!--        const loadingEl = document.getElementById('cover-loading');-->
<!--        if (loadingEl) {-->
<!--            loadingEl.remove();-->
<!--        }-->
<!--    }-->

<!--    function showMessage(message, type) {-->
<!--        const messageEl = document.createElement('div');-->
<!--        messageEl.className = `message-box ${type}`;-->
<!--        messageEl.textContent = message;-->

<!--        // æ¸…é™¤ä¹‹å‰çš„æ¶ˆæ¯-->
<!--        messageContainer.innerHTML = '';-->
<!--        messageContainer.appendChild(messageEl);-->

<!--        // 5ç§’åè‡ªåŠ¨æ¸…é™¤æ¶ˆæ¯-->
<!--        setTimeout(() => {-->
<!--            messageEl.remove();-->
<!--        }, 5000);-->
<!--    }-->
<!--</script>-->
<!--</body>-->
<!--</html>-->

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°è¯´å°é¢æ‰¹é‡æ›´æ–°å·¥å…·</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            color: #333;
        }
        .book-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .book-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            position: relative;
        }
        .book-card.selected {
            border-color: #1890ff;
            background-color: #e6f7ff;
        }
        .book-cover {
            width: 100%;
            height: 220px;
            object-fit: cover;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        .book-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .book-author {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
        }
        .checkbox {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        .controls {
            margin: 20px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .pagination {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        button {
            padding: 8px 16px;
            background-color: #1890ff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #40a9ff;
        }
        button:disabled {
            background-color: #d9d9d9;
            cursor: not-allowed;
        }
        .prompt-input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            font-size: 24px;
            font-weight: bold;
        }
        .status-message {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }
        .status-message.success {
            background-color: #f6ffed;
            border: 1px solid #b7eb8f;
            color: #52c41a;
        }
        .status-message.error {
            background-color: #fff2f0;
            border: 1px solid #ffccc7;
            color: #ff4d4f;
        }
        .status-message.info {
            background-color: #e6f7ff;
            border: 1px solid #91d5ff;
            color: #1890ff;
        }
        .book-description {
            font-size: 12px;
            color: #888;
            max-height: 60px;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
        }
        .page-size-selector {
            margin-left: 10px;
        }
        .prompt-container {
            margin: 15px 0;
            border: 1px solid #e8e8e8;
            border-radius: 8px;
            padding: 15px;
            background-color: #fafafa;
        }

        .prompt-label {
            display: block;
            font-weight: bold;
            margin-bottom: 8px;
            color: #333;
        }

        .prompt-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            font-size: 14px;
            resize: vertical;
            min-height: 80px;
            font-family: inherit;
        }

        .prompt-tips {
            margin-top: 8px;
            font-size: 12px;
            color: #888;
            line-height: 1.5;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>å°è¯´å°é¢æ‰¹é‡æ›´æ–°å·¥å…·</h1>

    <div class="controls">
        <div>
            <button id="selectAll">å…¨é€‰</button>
            <button id="deselectAll">å–æ¶ˆå…¨é€‰</button>
            <button id="generateCovers">ç”Ÿæˆé€‰ä¸­å›¾ç‰‡</button>
            <select id="pageSizeSelector" class="page-size-selector">
                <option value="10">10æ¡/é¡µ</option>
                <option value="20" selected>20æ¡/é¡µ</option>
                <option value="50">50æ¡/é¡µ</option>
                <option value="100">100æ¡/é¡µ</option>
            </select>
        </div>
        <div class="pagination">
            <button id="prevPage" disabled>ä¸Šä¸€é¡µ</button>
            <span id="pageInfo">ç¬¬ 1 é¡µ</span>
            <button id="nextPage">ä¸‹ä¸€é¡µ</button>
        </div>
    </div>

    <div class="prompt-container">
        <label for="promptTemplate" class="prompt-label">AIç»˜å›¾æç¤ºè¯æ¨¡æ¿:</label>
        <textarea id="promptTemplate" class="prompt-input" rows="3"
                  placeholder="è¾“å…¥AIå›¾ç‰‡ç”Ÿæˆæç¤ºè¯æ¨¡æ¿ï¼Œæ”¯æŒä»¥ä¸‹å˜é‡ï¼š
- {bookName}: ä¹¦å
- {authorName}: ä½œè€…å
- {bookDesc}: ä¹¦ç±æè¿°
- {categoryName}: å°è¯´åˆ†ç±»
- {workDirection}: ç”·é¢‘/å¥³é¢‘">ä¸ºå°è¯´ã€Š{bookName}ã€‹åˆ›å»ºä¸€ä¸ªç²¾ç¾çš„å°é¢å›¾ç‰‡ï¼Œé£æ ¼ä¸º{categoryName}ç±»å‹ï¼Œ{workDirection}å°è¯´ã€‚
ä½œè€…æ˜¯{authorName}ï¼Œå†…å®¹ç®€ä»‹ï¼š{bookDesc}
æ•´ä½“æ•ˆæœè¦é«˜æ¸…ç»†è…»ï¼Œå…·æœ‰è§†è§‰å†²å‡»åŠ›ï¼Œé€‚åˆä½œä¸ºä¸“ä¸šå°è¯´å°é¢ã€‚</textarea>
        <div class="prompt-tips">æç¤ºï¼šåˆç†çš„æç¤ºè¯å¯ä»¥ç”Ÿæˆæ›´å¥½çš„å°é¢ã€‚å»ºè®®åŒ…å«ä¹¦åã€ç±»å‹å’Œç®€çŸ­æè¿°ã€‚æè¿°ä»…ä½¿ç”¨å‰200å­—ã€‚</div>
    </div>

    <div id="statusMessages"></div>

    <div class="book-list" id="bookList">
        <!-- ä¹¦ç±åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
    </div>
</div>

<div class="loading" id="loading" style="display: none;">
    <div>å¤„ç†ä¸­ï¼Œè¯·ç¨å€™...</div>
</div>

<script>
    // å…¨å±€å˜é‡
    let currentBooks = []; // å½“å‰é¡µé¢æ˜¾ç¤ºçš„ä¹¦ç±
    let currentPage = 1;   // å½“å‰é¡µç 
    let pageSize = 20;     // æ¯é¡µæ•°é‡
    let totalBooks = 0;    // æ€»ä¹¦ç±æ•°
    let totalPages = 1;    // æ€»é¡µæ•°
    let selectedBooks = new Map(); // ä½¿ç”¨Mapå­˜å‚¨é€‰ä¸­çš„ä¹¦ç±ï¼Œé”®ä¸ºä¹¦ç±ID

    // DOMå…ƒç´ 
    const bookListEl = document.getElementById('bookList');
    const prevPageBtn = document.getElementById('prevPage');
    const nextPageBtn = document.getElementById('nextPage');
    const pageInfoEl = document.getElementById('pageInfo');
    const selectAllBtn = document.getElementById('selectAll');
    const deselectAllBtn = document.getElementById('deselectAll');
    const generateCoversBtn = document.getElementById('generateCovers');
    const promptTemplateEl = document.getElementById('promptTemplate');
    const loadingEl = document.getElementById('loading');
    const statusMessagesEl = document.getElementById('statusMessages');
    const pageSizeSelector = document.getElementById('pageSizeSelector');

    // åˆå§‹åŒ–
    window.onload = function() {
        fetchBooks(currentPage, pageSize);

        // ç»‘å®šäº‹ä»¶
        prevPageBtn.addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                fetchBooks(currentPage, pageSize);
            }
        });

        nextPageBtn.addEventListener('click', () => {
            if (currentPage < totalPages) {
                currentPage++;
                fetchBooks(currentPage, pageSize);
            }
        });

        selectAllBtn.addEventListener('click', selectAllBooks);
        deselectAllBtn.addEventListener('click', deselectAllBooks);
        generateCoversBtn.addEventListener('click', generateSelectedCovers);

        pageSizeSelector.addEventListener('change', () => {
            pageSize = parseInt(pageSizeSelector.value);
            currentPage = 1; // åˆ‡æ¢æ¯é¡µæ•°é‡åé‡ç½®ä¸ºç¬¬ä¸€é¡µ
            fetchBooks(currentPage, pageSize);
        });
    };

    // // ä¿®æ”¹ç¿»é¡µé€»è¾‘ï¼Œç¡®ä¿æœ€åä¸€é¡µä¸ä¼šä¸ä¹‹å‰é¡µé‡å¤
    // async function fetchBooks(pageNum, pageSize) {
    //     showLoading();
    //     try {
    //         // ç¡®ä¿é¡µç ä¸è¶…è¿‡æ€»é¡µæ•°
    //         if (totalPages > 0 && pageNum > totalPages) {
    //             pageNum = totalPages;
    //         }
    //
    //         const response = await fetch(`http://127.0.0.1:8888/api/front/book/listAll?pageNum=${pageNum}&pageSize=${pageSize}`);
    //
    //         if (!response.ok) {
    //             throw new Error(`HTTPé”™è¯¯: ${response.status}`);
    //         }
    //
    //         const data = await response.json();
    //
    //         if (data.code !== "00000") {
    //             throw new Error(`APIé”™è¯¯: ${data.message || 'æœªçŸ¥é”™è¯¯'}`);
    //         }
    //
    //         // æ›´æ–°å…¨å±€å˜é‡
    //         currentBooks = data.data.list || [];
    //         totalBooks = data.data.total || 0;
    //         totalPages = Math.ceil(totalBooks / pageSize);
    //
    //         // è®¡ç®—æ€»é¡µæ•°æ—¶ä½¿ç”¨å‘ä¸Šå–æ•´
    //         totalPages = Math.max(1, Math.ceil(totalBooks / pageSize));
    //
    //         // å¦‚æœå½“å‰é¡µè¶…è¿‡äº†æ€»é¡µæ•°ï¼Œé‡æ–°è¯·æ±‚æœ€åä¸€é¡µ
    //         if (pageNum > totalPages && totalPages > 0) {
    //             return fetchBooks(totalPages, pageSize);
    //         }
    //
    //         // æ¸²æŸ“ä¹¦ç±åˆ—è¡¨
    //         renderBooks();
    //
    //         // æ›´æ–°åˆ†é¡µæ§ä»¶
    //         updatePaginationControls();
    //     } catch (error) {
    //         showStatusMessage(`è·å–ä¹¦ç±åˆ—è¡¨å¤±è´¥: ${error.message}`, 'error');
    //     } finally {
    //         hideLoading();
    //     }
    // }
    async function fetchBooks(pageNum, pageSize) {
        showLoading();
        try {
            // ç¡®ä¿é¡µç æœ‰æ•ˆ
            pageNum = Math.max(1, Math.min(pageNum, totalPages || 1));

            const response = await fetch(`http://127.0.0.1:8888/api/front/book/listAll?pageNum=${pageNum}&pageSize=${pageSize}`);

            if (!response.ok) {
                throw new Error(`HTTPé”™è¯¯: ${response.status}`);
            }

            const data = await response.json();

            if (data.code !== "00000") {
                throw new Error(`APIé”™è¯¯: ${data.message || 'æœªçŸ¥é”™è¯¯'}`);
            }

            // æ›´æ–°å…¨å±€å˜é‡
            currentBooks = data.data.list || [];
            totalBooks = data.data.total || 0;
            totalPages = Math.max(1, Math.ceil(totalBooks / pageSize));
            currentPage = pageNum; // ç¡®ä¿å½“å‰é¡µä¸è¯·æ±‚é¡µä¸€è‡´

            // æ¸²æŸ“ä¹¦ç±åˆ—è¡¨
            renderBooks();

            // æ›´æ–°åˆ†é¡µæ§ä»¶
            updatePaginationControls();
        } catch (error) {
            showStatusMessage(`è·å–ä¹¦ç±åˆ—è¡¨å¤±è´¥: ${error.message}`, 'error');
        } finally {
            hideLoading();
        }
    }

    // æ›´æ–°åˆ†é¡µæ§ä»¶å‡½æ•°
    function updatePaginationControls() {
        pageInfoEl.textContent = `ç¬¬ ${currentPage} é¡µï¼Œå…± ${totalPages} é¡µï¼Œæ€»è®¡ ${totalBooks} æ¡`;
        prevPageBtn.disabled = currentPage <= 1;
        nextPageBtn.disabled = currentPage >= totalPages || totalPages === 0;
    }

    // ä¸‹ä¸€é¡µæŒ‰é’®äº‹ä»¶å¤„ç†
    nextPageBtn.addEventListener('click', () => {
        if (currentPage < totalPages) {
            currentPage++;
            fetchBooks(currentPage, pageSize);
        }
    });

    // æ¸²æŸ“ä¹¦ç±åˆ—è¡¨
    function renderBooks() {
        bookListEl.innerHTML = '';

        if (currentBooks.length === 0) {
            bookListEl.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 20px;">æš‚æ— æ•°æ®</div>';
            return;
        }

        currentBooks.forEach(book => {
            const isSelected = selectedBooks.has(book.id);

            const bookCard = document.createElement('div');
            bookCard.className = `book-card ${isSelected ? 'selected' : ''}`;
            bookCard.dataset.id = book.id;

            // å‡†å¤‡å›¾ç‰‡URLï¼Œå¦‚æœæœ‰ç¼“å­˜çš„æ–°å›¾ç‰‡å°±ä½¿ç”¨æ–°å›¾ç‰‡
            const bookFromMap = selectedBooks.get(book.id);
            const coverImg = bookFromMap && bookFromMap.newImageUrl
                ? bookFromMap.newImageUrl
                : book.picUrl;

            bookCard.innerHTML = `
                <input type="checkbox" class="checkbox" ${isSelected ? 'checked' : ''}>
                <img src="${coverImg || ''}" alt="${book.bookName}" class="book-cover"
                     onerror="this.src='http://localhost:20000/default.gif'">
                <div class="book-title">${book.bookName || 'æœªçŸ¥æ ‡é¢˜'}</div>
                <div class="book-author">ä½œè€…: ${book.authorName || 'æœªçŸ¥'}</div>
                <div class="book-description">${book.bookDesc || 'æš‚æ— æè¿°'}</div>
                ${bookFromMap && bookFromMap.newImageUrl ? '<div style="color: green; margin-top: 5px;">âœ“ å›¾ç‰‡å·²æ›´æ–°</div>' : ''}
            `;

            const checkbox = bookCard.querySelector('.checkbox');
            checkbox.addEventListener('change', () => {
                if (checkbox.checked) {
                    // æ·»åŠ åˆ°é€‰ä¸­åˆ—è¡¨
                    selectedBooks.set(book.id, {...book});
                    bookCard.classList.add('selected');
                } else {
                    // ä»é€‰ä¸­åˆ—è¡¨ç§»é™¤
                    selectedBooks.delete(book.id);
                    bookCard.classList.remove('selected');
                }
            });

            bookListEl.appendChild(bookCard);
        });
    }

    // å…¨é€‰å½“å‰é¡µé¢çš„ä¹¦ç±
    function selectAllBooks() {
        currentBooks.forEach(book => {
            selectedBooks.set(book.id, {...book});
        });
        renderBooks();
    }

    // å–æ¶ˆé€‰ä¸­å½“å‰é¡µé¢çš„ä¹¦ç±
    function deselectAllBooks() {
        currentBooks.forEach(book => {
            selectedBooks.delete(book.id);
        });
        renderBooks();
    }

    function decodeHtmlEntities(str) {
        const txt = document.createElement('textarea');
        txt.innerHTML = str;
        return txt.value;
    }


    // ç”Ÿæˆé€‰ä¸­çš„å°é¢
    async function generateSelectedCovers() {
        if (selectedBooks.size === 0) {
            showStatusMessage('è¯·è‡³å°‘é€‰æ‹©ä¸€æœ¬ä¹¦ç±', 'error');
            return;
        }

        showLoading();

        // è·å–é€‰ä¸­çš„ä¹¦ç±åˆ—è¡¨
        const booksToUpdate = Array.from(selectedBooks.values());
        let successCount = 0;
        let failCount = 0;

        for (const book of booksToUpdate) {
            try {
                // 1. ç”Ÿæˆæç¤ºè¯
                const promptTemplate = promptTemplateEl.value;
                const workDirectionText = book.workDirection === 0 ? 'ç”·é¢‘' : 'å¥³é¢‘';
                const prompt = promptTemplate
                    .replace('{bookName}', book.bookName || '')
                    .replace('{authorName}', book.authorName || 'æœªçŸ¥ä½œè€…')
                    .replace('{bookDesc}', (book.bookDesc || '').substring(0, 200)) // é™åˆ¶æè¿°é•¿åº¦
                    .replace('{categoryName}', book.categoryName || 'æœªåˆ†ç±»')
                    .replace('{workDirection}', workDirectionText);

                // 2. è°ƒç”¨æ–‡ç”Ÿå›¾API
                showStatusMessage(`æ­£åœ¨ä¸ºã€Š${book.bookName}ã€‹ç”Ÿæˆå°é¢...`, 'info');
                const imageResponse = await fetch('http://127.0.0.1:8888/api/front/ai/textToImage', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ text: prompt })
                });

                if (!imageResponse.ok) {
                    throw new Error(`å›¾ç‰‡ç”Ÿæˆè¯·æ±‚å¤±è´¥: ${imageResponse.status}`);
                }

                const imageData = await imageResponse.json();

                if (imageData.code !== "00000" || !imageData.data) {
                    throw new Error(`å›¾ç‰‡ç”Ÿæˆå¤±è´¥: ${imageData.message || 'æœªçŸ¥é”™è¯¯'}`);
                }

                const pngUrl = imageData.data;

                // 3. è°ƒç”¨PNGè½¬JPG API
                showStatusMessage(`æ­£åœ¨è½¬æ¢ã€Š${book.bookName}ã€‹çš„å°é¢æ ¼å¼...`, 'info');
                const convertResponse = await fetch('http://127.0.0.1:8888/api/front/ai/pngToJpg', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ url: pngUrl })
                });

                if (!convertResponse.ok) {
                    throw new Error(`å›¾ç‰‡è½¬æ¢è¯·æ±‚å¤±è´¥: ${convertResponse.status}`);
                }

                const convertData = await convertResponse.json();

                if (convertData.code !== "00000" || !convertData.data) {
                    throw new Error(`å›¾ç‰‡è½¬æ¢å¤±è´¥: ${convertData.message || 'æœªçŸ¥é”™è¯¯'}`);
                }

                const jpgUrl = convertData.data;

                // 4. æ›´æ–°ä¹¦ç±å°é¢
                showStatusMessage(`æ­£åœ¨æ›´æ–°ã€Š${book.bookName}ã€‹çš„å°é¢ä¿¡æ¯...`, 'info');

                // ç¡®ä¿æ‰€æœ‰å¿…è¦å­—æ®µéƒ½æœ‰å€¼ï¼Œé˜²æ­¢ç©ºå€¼å¯¼è‡´åç«¯é”™è¯¯
                const updateData = {
                    id: book.id,
                    workDirection: book.workDirection ?? 0,
                    categoryId: book.categoryId ?? 0,
                    categoryName: book.categoryName || 'æœªåˆ†ç±»',
                    picUrl: jpgUrl,
                    bookName: book.bookName || 'æœªå‘½å',
                    bookDesc: decodeHtmlEntities(book.bookDesc || ''),
                    bookStatus: book.bookStatus ?? 0,
                    isVip: book.isVip ?? 0,
                    authorId: book.authorId ?? 0,
                    authorName: book.authorName || 'æœªçŸ¥ä½œè€…'
                };

                const updateResponse = await fetch('http://127.0.0.1:20003/api/inner/book/updateBook', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updateData)
                });

                if (!updateResponse.ok) {
                    throw new Error(`ä¹¦ç±ä¿¡æ¯æ›´æ–°è¯·æ±‚å¤±è´¥: ${updateResponse.status}`);
                }

                const updateResult = await updateResponse.json();

                if (updateResult.code !== "00000") {
                    throw new Error(`ä¹¦ç±ä¿¡æ¯æ›´æ–°å¤±è´¥: ${updateResult.message || 'æœªçŸ¥é”™è¯¯'}`);
                }

                // æ›´æ–°é€‰ä¸­ä¹¦ç±ä¸­çš„ä¿¡æ¯
                const updatedBook = selectedBooks.get(book.id);
                if (updatedBook) {
                    updatedBook.picUrl = jpgUrl;
                    updatedBook.newImageUrl = jpgUrl;
                    selectedBooks.set(book.id, updatedBook);
                }

                showStatusMessage(`ã€Š${book.bookName}ã€‹å°é¢æ›´æ–°æˆåŠŸï¼`, 'success');
                successCount++;
            } catch (error) {
                showStatusMessage(`ã€Š${book.bookName}ã€‹å¤„ç†å¤±è´¥: ${error.message}`, 'error');
                failCount++;
            }
        }

        // æ›´æ–°æ€»ç»“æœ
        showStatusMessage(`å¤„ç†å®Œæˆ: ${successCount}æœ¬æˆåŠŸï¼Œ${failCount}æœ¬å¤±è´¥`,
            successCount > 0 ? 'success' : 'error');

        // é‡æ–°åŠ è½½å½“å‰é¡µé¢æ•°æ®ï¼Œæ˜¾ç¤ºæœ€æ–°çŠ¶æ€
        fetchBooks(currentPage, pageSize);

        hideLoading();
    }

    // æ˜¾ç¤ºåŠ è½½ä¸­
    function showLoading() {
        loadingEl.style.display = 'flex';
    }

    // éšè—åŠ è½½ä¸­
    function hideLoading() {
        loadingEl.style.display = 'none';
    }

    // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
    function showStatusMessage(message, type = 'info') {
        const messageEl = document.createElement('div');
        messageEl.className = `status-message ${type}`;
        messageEl.textContent = message;

        statusMessagesEl.appendChild(messageEl);

        // 5ç§’åè‡ªåŠ¨ç§»é™¤
        setTimeout(() => {
            if (statusMessagesEl.contains(messageEl)) {
                statusMessagesEl.removeChild(messageEl);
            }
        }, 5000);
    }
</script>
</body>
</html>